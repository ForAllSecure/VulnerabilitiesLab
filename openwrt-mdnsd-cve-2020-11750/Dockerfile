FROM debian:buster-slim
LABEL maintainer="guido@guidovranken.com"

RUN apt-get update --allow-releaseinfo-change && \
        apt-get install --no-install-recommends -y build-essential \
        ca-certificates clang gcc-multilib \
        g++-multilib subversion libc6-dbg

WORKDIR /src

# Get and build the latest libFuzzer
RUN svn co https://llvm.org/svn/llvm-project/compiler-rt/trunk/lib/fuzzer Fuzzer
RUN cd /src/Fuzzer && ./build.sh

COPY /src/* /src/

# Compile the harness
RUN    CC=clang \
       CXX=clang++ \
       LIBFUZZER_A_PATH="/src/Fuzzer/libFuzzer.a" \
       CFLAGS="-fsanitize=address,undefined,fuzzer-no-link -g -O1" \
       CXXFLAGS="-fsanitize=address,undefined,fuzzer-no-link -g -O1" make
