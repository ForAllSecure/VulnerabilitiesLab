#define _GNU_SOURCE
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <math.h>
#include <complex.h>

/* By writing the result to /dev/null, Valgrind can check if it contains uninitialized bytes */
#define WRITE_DEV_NULL(var) \
    { \
        FILE* fp = fopen("/dev/null", "wb"); \
        if ( !fp ) abort(); \
        if ( fwrite(&var, sizeof(var), 1, fp) != 1 ) abort(); \
        if ( fclose(fp) != 0 ) abort(); \
    }

/* Temporarily disabled */
#undef WRITE_DEV_NULL
#define WRITE_DEV_NULL(...)

#define CALL_MATH_FUNC1(return_type, fn, inp1_type) { \
    inp1_type inp1; \
    if ( num_read >= sizeof(inp1) ) { \
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        return_type ret = fn(inp1); \
        WRITE_DEV_NULL(ret); \
    } \
}

#define CALL_MATH_FUNC2(return_type, fn, inp1_type, inp2_type) { \
    inp1_type inp1; \
    inp2_type inp2; \
    if ( num_read >= sizeof(inp1) + sizeof(inp2) ) { \
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        memcpy(&inp2, inbuffer + sizeof(inp1), sizeof(inp2)); \
        return_type ret = fn(inp1, inp2); \
        WRITE_DEV_NULL(ret); \
    } \
}

#define CALL_MATH_FUNC3(return_type, fn, inp1_type, inp2_type, inp3_type) { \
    inp1_type inp1; \
    inp2_type inp2; \
    inp3_type inp3; \
    if ( num_read >= sizeof(inp1) + sizeof(inp2) + sizeof(inp3) ) { \
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        memcpy(&inp2, inbuffer + sizeof(inp1), sizeof(inp2)); \
        memcpy(&inp3, inbuffer + sizeof(inp1) + sizeof(inp2), sizeof(inp3)); \
        return_type ret = fn(inp1, inp2, inp3); \
        WRITE_DEV_NULL(ret); \
    } \
}

int main(int argc, char** argv)
{
    FILE* fp = NULL;
    size_t num_read = 0;
    unsigned char inbuffer[256];

    if ( argc != 2 || (fp = fopen(argv[1], "rb'")) == NULL ) {
        printf("Absent or invalid input file, exiting.\n");
        return 0;
    }

    memset(inbuffer, 0, sizeof(inbuffer));

    num_read = fread(inbuffer, 1, 256, fp);

    fclose(fp); fp = NULL;

    if ( num_read < 4 ) {
        return 0;
    }

#include "function_calls.h"
    {
        double inp1;
        double s;
        double c;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        /* noret */ sincos(inp1, &s, &c);
    }
    {
        float inp1;
        float s;
        float c;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        /* noret */ sincosf(inp1, &s, &c);
    }
    {
        long double inp1;
        long double s;
        long double c;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        /* noret */ sincosl(inp1, &s, &c);
    }

    {
        double inp1;
        int exp;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        double ret = frexp(inp1, &exp);
        //WRITE_DEV_NULL(ret);
    }

    {
        float inp1;
        int exp;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        float ret = frexpf(inp1, &exp);
        WRITE_DEV_NULL(ret);
    }

    {
        long double inp1;
        int exp;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        long double ret = frexpl(inp1, &exp);
        WRITE_DEV_NULL(ret);
    }

    {
        double inp1;
        int signp;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        double ret = lgamma_r(inp1, &signp);
        WRITE_DEV_NULL(ret);
    }

    {
        float inp1;
        int signp;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        float ret = lgammaf_r(inp1, &signp);
        WRITE_DEV_NULL(ret);
    }

    {
        long double inp1;
        int signp;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        long double ret = lgammal_r(inp1, &signp);
        WRITE_DEV_NULL(ret);
    }

    {
        double inp1;
        double out;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        double ret = modf(inp1, &out);
        WRITE_DEV_NULL(ret);
    }

    {
        float inp1;
        float out;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        float ret = modff(inp1, &out);
        WRITE_DEV_NULL(ret);
    }

    {
        long double inp1;
        long double out;
        memcpy(&inp1, inbuffer, sizeof(inp1)); \
        long double ret = modfl(inp1, &out);
        WRITE_DEV_NULL(ret);
    }

    {
        double inp1;
        double inp2;
        int out;
        memcpy(&inp1, inbuffer, sizeof(inp1));
        memcpy(&inp2, inbuffer + sizeof(inp1), sizeof(inp2));
        double ret = remquo(inp1, inp2, &out);
        WRITE_DEV_NULL(ret);
    }

    {
        float inp1;
        float inp2;
        int out;
        memcpy(&inp1, inbuffer, sizeof(inp1));
        memcpy(&inp2, inbuffer + sizeof(inp1), sizeof(inp2));
        float ret = remquof(inp1, inp2, &out);
        WRITE_DEV_NULL(ret);
    }

    {
        long double inp1;
        long double inp2;
        int out;
        memcpy(&inp1, inbuffer, sizeof(inp1));
        memcpy(&inp2, inbuffer + sizeof(inp1), sizeof(inp2));
        long double ret = remquol(inp1, inp2, &out);
        WRITE_DEV_NULL(ret);
    }

    return 0;
}
