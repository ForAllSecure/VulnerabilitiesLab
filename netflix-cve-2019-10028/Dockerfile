FROM ubuntu:18.04 as builder

# Install Essentials
RUN apt-get update && \
    apt-get install -y \
    libcurl4-openssl-dev zlib1g-dev libssl-dev build-essential git

# Get the current dial-reference repo
WORKDIR /dial-reference
RUN git clone https://github.com/Netflix/dial-reference.git . && \
    # Check out version before flaw was fixed
    git checkout bfde1461449f6c0dfde3d2a826b97cace325cc75 && \
    git checkout HEAD^ && \
    # Need to remove function call that uses unsupported IOCTL
    sed -i -e 's/get_local_address();//g' server/quick_ssdp.c && \
    make

FROM ubuntu:18.04

WORKDIR /fuzz

COPY --from=builder /dial-reference/server/dialserver .
COPY --from=builder /dial-reference/server/libnfCallbacks.so /lib/x86_64-linux-gnu
COPY http.dict .
