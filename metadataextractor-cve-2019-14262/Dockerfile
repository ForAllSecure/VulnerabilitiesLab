FROM gradle:6.7.1-jdk15 as builder

RUN apt-get update && apt-get -y install \
        patch && \
    rm -rf /var/apt/lists/*

WORKDIR /build
COPY exception-handler.patch exception-handler.patch
RUN git clone https://github.com/drewnoakes/metadata-extractor.git -b 2.12.0 && \
    cd metadata-extractor && \
    patch -p1 < ../exception-handler.patch && \
    sed -e "s/'1.6'/'1.8'/g" -i build.gradle && \
    gradle --no-daemon jar && \
    mkdir ../artifacts && \
    cp build/libs/metadata-extractor-2.1.1.jar ../artifacts && \
    wget https://repo1.maven.org/maven2/com/adobe/xmp/xmpcore/6.1.11/xmpcore-6.1.11.jar && \
    cp xmpcore-6.1.11.jar ../artifacts

FROM openjdk:17-jdk-slim

WORKDIR /app
COPY --from=builder /build/artifacts/*.jar ./

ENTRYPOINT ["java", "-cp", "/app/xmpcore-6.1.11.jar:/app/metadata-extractor-2.1.1.jar", "com.drew.imaging.ImageMetadataReader"]
