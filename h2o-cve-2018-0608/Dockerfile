FROM ubuntu

RUN export DEBIAN_FRONTEND="noninteractive" && \
    apt-get update && \
    apt-get install -y clang cmake build-essential git libssl-dev zlib1g-dev

WORKDIR /h2o
RUN git clone https://github.com/h2o/h2o . && \
    git checkout 69506c9e2defa4922f62f389c76d89e9274b3cc1 && \
    git checkout HEAD^
COPY CMakeLists.txt .
COPY standalone.cc fuzz

RUN mkdir /fuzz

RUN rm -rf build && mkdir build && cd build && \
    CC=clang CXX=clang++ cmake -DBUILD_FUZZER=1 -DFUZZER_STANDALONE=1 .. && make && \
    mv h2o h2o-fuzzer-http1-standalone h2o-fuzzer-http2-standalone h2o-fuzzer-url-standalone /fuzz

RUN rm -rf build && mkdir build && cd build && \
    CC=clang CXX=clang++ cmake -DBUILD_FUZZER=1 .. && make && \
    mv h2o-fuzzer-http1 h2o-fuzzer-http2 h2o-fuzzer-url /fuzz

WORKDIR /fuzz
COPY h2o.conf .
COPY h2o-fuzzer-http1.dict .
COPY h2o-fuzzer-http2.dict .
