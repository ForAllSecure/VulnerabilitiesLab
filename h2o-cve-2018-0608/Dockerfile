FROM ubuntu AS base

RUN apt-get update && \
    apt-get install -y libssl-dev zlib1g-dev

FROM base AS builder

RUN export DEBIAN_FRONTEND="noninteractive" && \
    apt-get update && \
    apt-get install -y cmake build-essential git

WORKDIR /h2o
RUN git clone https://github.com/h2o/h2o . && \
    git checkout 69506c9e2defa4922f62f389c76d89e9274b3cc1 && \
    git checkout HEAD^

RUN mkdir build && cd build && cmake .. && make

FROM base

WORKDIR /fuzz
COPY --from=builder /h2o/build/h2o .
COPY h2o.conf .
