#!/bin/bash
set -ex

mkdir fuzzers

# Build library with ASAN and libfuzzer instrumentation
autoreconf -vfi
./configure CC=clang LD=clang CFLAGS="-g -fsanitize=fuzzer-no-link -fsanitize=address -fno-omit-frame-pointer" LDFLAGS="-g -fsanitize=fuzzer-no-link -fsanitize=address -fno-omit-frame-pointer" --host=x86_64-linux-gnu || exit
make -j4

# Libfuzzer builds
LIBFUZZER_FLAGS="-fsanitize=fuzzer,address -fno-omit-frame-pointer"
clang deluxe-encode-harness.c src/.libs/libonig.a -Isrc -g $LIBFUZZER_FLAGS -o fuzzers/deluxe-libfuzzer

# Remake library without ASAN
make distclean
autoreconf -vfi
./configure CC=clang LD=clang CFLAGS="-g" LDFLAGS="-g" --host=x86_64-linux-gnu
make -j4

# Standalone builds
clang deluxe-encode-harness.c standalone.c src/.libs/libonig.a -Isrc -g -o fuzzers/deluxe-standalone
