FROM ubuntu:20.10 AS builder

RUN export DEBIAN_FRONTEND="noninteractive" && \
    apt-get update -qq && \
    apt-get install -y build-essential autotools-dev automake autoconf libtool git libssl-dev

WORKDIR /sthttpd
RUN git clone https://github.com/blueness/sthttpd . && \
    git checkout c0dc63a49d8605649f1d8e4a96c9b468b0bff660 && \
    git checkout HEAD^

RUN ./autogen.sh && ./configure && make

FROM ubuntu:20.10

RUN apt-get update && apt-get install -y ubuntu-dbgsym-keyring && apt-get clean all && \
    echo "deb http://ddebs.ubuntu.com groovy main restricted universe multiverse\n\
deb http://ddebs.ubuntu.com groovy-updates main restricted universe multiverse\n\
deb http://ddebs.ubuntu.com groovy-proposed main restricted universe multiverse\n" | \
    tee -a /etc/apt/sources.list.d/ddebs.list

RUN apt-get update && \
    apt-get install -y libssl1.1-dbgsym libc6-dbg && \
    apt-get clean all

WORKDIR /fuzz
COPY --from=builder /sthttpd/src/thttpd .
